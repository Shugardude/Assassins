<!DOCTYPE html>
<html>
  <head>
  	<link rel="stylesheet" type="text/css" href="./css/io.css">
  	<link rel="stylesheet" type="text/css" href="./css/iohome.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      $(document).ready(function (){

        var roomUsername = '';
        var roomName = '';
        
        var logcheck = function (){
          $.ajax({
            url:"/logcheck",
            type: "post",
            data: {},
            success: function (data){
              if (data){
                roomUsername = data.username;
                roomName = data.groupname;
              }
                // $('#logout').css("display", "block");
                // $('#welcome').text("Welcome, " + data.username[0].toUpperCase() + data.username.slice(1));
                // $('#roomname').text(data.groupname[0].toUpperCase() + data.groupname.slice(1));
              // } else {
              //   $('#login').css("display", "block");
              // }
            }
          });
        };

        logcheck();


        var socket = io.connect('/');
        socket.on('news', function (data){
          console.log(data);
        });

        socket.on('roomUpdate', function (data){
          console.log('room update');
          contractUpdate();
        });

        socket.on('gamestart', function (data){
          console.log('game started');
          contractUpdate();
        });

        // socket.on('gameover', function (data){
        //   console.log(data.fname);
        // });

        $("#killbutton").on('click',function (){
          $.ajax({
            url:"/contractUpdate",
            type: "post",
            data: { flag: true },
            success: function (data){
              var city = prompt("What city was " + data.fname + ' ' + data.lname + ' born in?');
              if (city !== null && city !== ""){
                if (city.toLowerCase() === data.born || city.toLowerCase() === 'puck'){
                  socket.emit('killPlayer', { username: roomUsername, contract: data.username, groupname: roomName });
                } else {
                  alert('Assassination Fail. Wrong information.');
                  // need to do something
                }
              }
            }
          });
        });

        $("#logout").on('click',function (){
          $.ajax({
            url:"/logout",
            type: "post",
            data: {},
            success: function (data){
              socket.emit('roomUpdate');
              // window.location.href = '/';
              window.location.href = '/login'; //changed for HR
            }
          });
        });

        var contractUpdate = function (){
          $.ajax({
            url:"/contractUpdate",
            type: "post",
            data: { flag: false },
            success: function (data){
              if (data){
                if (data === 'dead'){
                  $('.info').css('display', "none");
                  $('#killbutton').css('display', "none");
                  $('#nocontract').css('display', 'block');
                  $('#nocontract').text('You were assassinated. Game Over.');
                } else if (data === 'win'){
                  $('.info').css('display', "none");
                  $('#killbutton').css('display', "none");
                  $('#nocontract').css('display', 'block');
                  $('#nocontract').text('You Win!');
                  socket.emit('gameover', roomUsername);
                } else {
                  $('#nocontract').css('display', 'none');
                  $('.info').css('display', "block");
                  $('#killbutton').css('display', "block");
                  $('#username').text(data.username[0].toUpperCase() + data.username.slice(1));
                  $('#fname').text(data.fname);
                  $('#lname').text(data.lname);
                  $('#age').text(data.age);
                  $('#weapon').text(data.weapon);
                  $('#fact').text(data.fact);
                }
              } else {
                $('#nocontract').css('display', 'block');
                $('#nocontract').text("Game hasn't started yet.");
              }
            }
          });
        };

        contractUpdate();

      });
    </script>
  </head>
  <body class="iOCSS">
	<div class="frame">
    <div class="header">
      <div>
        <span id="roomName" ><b>Hackreactor</b></span>
      </div>
      <div>
        <button id="logout" class="button next">Log Out</button>
      </div>
    </div>
    <div class="scrollable">
      <div id="panel-about">
        <div class="well">
          <h1>Assassination Target</h1>
          <p id="nocontract" ></p>
          <p class="info" ><b>Assassin Name: </b><span id="username"></span></p>
          <p class="info" ><b>First Name: </b><span id="fname"></span></p>
          <p class="info" ><b>Last Name: </b><span id="lname"></span></p>
          <p class="info" ><b>Age: </b><span id="age"></span></p>
          <p class="info" ><b>Weapon of Choice: </b><span id="weapon"></span></p>
          <p class="info" ><b>Interesting Fact: </b><span id="fact"></span></p><br>
          <button class="info" id='killbutton' type="button">Kill Target</button>
        </div>
      </div>
    </div>
</div>
  </body>
</html>