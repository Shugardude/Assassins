<!DOCTYPE html>
<html>
  <head>
  	<link rel="stylesheet" type="text/css" href="./css/io.css">
  	<link rel="stylesheet" type="text/css" href="./css/assassin.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      $(document).ready(function (){

        var socket = io.connect('/');
        socket.on('roomUpdate', function (data){
          contractUpdate();
        });
        socket.on('gamestart', function (data){
          contractUpdate();
        });

        var roomObj = {
          username: '',
          roomName: '',
          conractName: ''
        };
        
        var logcheck = function (){
          $.ajax({
            url:"/logcheck",
            type: "post",
            data: {},
            success: function (data){
              roomObj.username = data.username;
              roomObj.roomName = data.groupname;
              $('.logo').text(data.groupname[0].toUpperCase() + data.groupname.slice(1));
            }
          });
        };

        $("#killbutton").on('click',function (){
          $.ajax({
            url:"/contractUpdate",
            type: "post",
            data: { flag: true },
            success: function (data){
              var secret = prompt("What is " + data.fname + " " + data.lname + "'s password?");
              if (secret !== null && secret !== ""){
                if (secret.toLowerCase() === data.secret || secret.toLowerCase() === 'puck'){
                  socket.emit('killPlayer', {
                    username: roomObj.username,
                    contract: data.username,
                    groupname: roomObj.roomName
                  });
                } else { alert('Assassination Fail. Wrong information.'); }
              }
            }
          });
        });

        $("#resetbutton").on('click',function (){
          $.ajax({
            url:"/reset",
            type: "post",
            data: {},
            success: function (data){
              socket.emit('roomUpdate');
              location.reload();
            }
          });
        });

        $("#logout").on('click',function (){
          $.ajax({
            url:"/logout",
            type: "post",
            data: {},
            success: function (data){
              socket.emit('roomUpdate');
              location.href = '/login';
            }
          });
        });

        var contractUpdate = function (){
          $.ajax({
            url:"/contractUpdate",
            type: "post",
            data: { flag: false },
            success: function (data){
              if (data){
                if (data.flag){
                  $('.info').css('display', "none");
                  $('#killbutton').css('display', "none");
                  $('#nocontract').css('display', 'block');
                  $('#nocontract').text(data.message);
                  if (data.flag === 'admin'){ $('#resetbutton').css('display', 'block'); }
                } else {
                  $('#nocontract').css('display', 'none');
                  $('.info').css('display', "block");
                  $('#killbutton').css('display', "block");
                  $('#name')[0].textContent = data.fname + " " + data.lname;
                  $('#username').text(data.username[0].toUpperCase() + data.username.slice(1));
                  $('#age').text(data.age);
                  $('#weapon').text(data.weapon);
                  $('#fact').text(data.fact);
                }
              } else {
                $('.info').css('display', "none");
                $('#killbutton').css('display', "none");
                $('#nocontract').css('display', 'block');
                $('#nocontract').text('You were assassinated. Game Over.');
              }
            }
          });
        };

        logcheck();
        contractUpdate();

      });
    </script>
  </head>
  <body class="iOCSS black">
    <div class="frame signIn_fancy">
      <div class="header">
        <h1>Welcome</h1>
        <div><button class="edit" type="button" id="logout">Log out</button></div>
      </div>
      <div class="scrollable">
        <div class="editor flex-none" id="divIn">
          <div class="well-header" id="infoarea">Target Profile</div>
          <div class="well">
            <h2 class="info" id="name"></h2>
            <p id="nocontract" ></p>
            <p class="info" ><b>Assassin Name: </b><span id="username"></span></p>
            <p class="info" ><b>Age: </b><span id="age"></span></p>
            <p class="info" ><b>Weapon of Choice: </b><span id="weapon"></span></p>
            <p class="info" ><b>Interesting Fact: </b><span id="fact"></span></p><br>
          </div>
          <button  class="red large" id="killbutton" >Kill Target</button>
          <button  class="black large" id="resetbutton" >Reset Game</button>
        </div>
      </div>
    </div>
  </body>
</html>